name: bootstrap nix

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "bootstrap-nix.sh"
      - ".github/workflows/bootstrap-nix.yml"
      - "flake.nix"
      - "flake.lock"
      - "modules/home/**"
      - "users/**"

jobs:
  lint-bootstrap:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Install lint tools
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck shfmt

      - name: Run shellcheck
        run: shellcheck bootstrap-nix.sh

      - name: Run shfmt check
        run: shfmt -d -i 2 bootstrap-nix.sh

  bootstrap-integration:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    permissions:
      contents: read
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-22.04
          - ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Runner preflight
        run: |
          sudo -n true
          lsb_release -a || cat /etc/os-release

      - name: Run bootstrap script
        id: bootstrap
        continue-on-error: true
        run: |
          set -euo pipefail
          export DEBIAN_FRONTEND=noninteractive
          timeout 45m bash ./bootstrap-nix.sh |& tee bootstrap.log

      - name: Assert bootstrap result
        env:
          BOOTSTRAP_OUTCOME: ${{ steps.bootstrap.outcome }}
        run: |
          if [ "$BOOTSTRAP_OUTCOME" != "success" ]; then
            echo "bootstrap-nix.sh failed"
            exit 1
          fi

      - name: Enable Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@565684385bcd71bad329742eefe8d12f2e765b39 # v13
        with:
          use-flakehub: false

      - name: Verify nix is installed and configured
        run: |
          set -euo pipefail
          command -v nix
          command -v nix-shell
          nix --version
          sudo systemctl is-active nix-daemon
          grep -q "experimental-features = nix-command flakes" /etc/nix/nix.conf
          nix flake metadata .
          nix build .#homeConfigurations.hrosten.activationPackage -L

      - name: Upload bootstrap log
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: bootstrap-log-${{ matrix.os }}
          path: bootstrap.log
          if-no-files-found: ignore
