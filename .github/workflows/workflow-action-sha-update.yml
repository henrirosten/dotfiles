name: workflow action sha update

on:
  schedule:
    - cron: "0 5 * * 1"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-action-shas:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Update pinned workflow action SHAs
        id: update
        run: |
          set -euo pipefail

          declare -A sha_cache

          resolve_tag_sha() {
            local action="$1"
            local tag="$2"
            local remote="https://github.com/${action}.git"
            local output sha=""

            output="$(git ls-remote --refs "$remote" "refs/tags/${tag}^{}" 2>/dev/null || true)"
            sha="$(printf '%s\n' "$output" | awk 'NR==1 { print $1 }')"

            if [ -z "$sha" ]; then
              output="$(git ls-remote --refs "$remote" "refs/tags/${tag}" 2>/dev/null || true)"
              sha="$(printf '%s\n' "$output" | awk 'NR==1 { print $1 }')"
            fi

            if [ -z "$sha" ]; then
              return 1
            fi

            printf '%s' "$sha"
          }

          updated=0

          while IFS= read -r file; do
            while IFS= read -r match; do
              [ -z "$match" ] && continue

              line_no="${match%%:*}"
              line="${match#*:}"

              if [[ ! "$line" =~ uses:[[:space:]]+([^@[:space:]]+)@([0-9a-f]{40})([[:space:]]*#[[:space:]]*([[:alnum:]_.\/-]+).*)?$ ]]; then
                continue
              fi

              action="${BASH_REMATCH[1]}"
              old_sha="${BASH_REMATCH[2]}"
              tag="${BASH_REMATCH[4]:-}"

              if [ -z "$tag" ]; then
                echo "::error file=${file},line=${line_no}::Pinned action '${action}' is missing an inline tag comment (example: '# v4')."
                exit 1
              fi

              key="${action}@${tag}"
              new_sha="${sha_cache[$key]:-}"
              if [ -z "$new_sha" ]; then
                if ! new_sha="$(resolve_tag_sha "$action" "$tag")"; then
                  echo "::error file=${file},line=${line_no}::Could not resolve ${action} tag '${tag}' to a commit SHA."
                  exit 1
                fi
                sha_cache["$key"]="$new_sha"
              fi

              if [ "$old_sha" != "$new_sha" ]; then
                sed -i "${line_no}s/${old_sha}/${new_sha}/" "$file"
                echo "Updated ${action} (${tag}) in ${file}:${line_no} (${old_sha:0:7} -> ${new_sha:0:7})"
                updated=1
              fi
            done < <(grep -nE 'uses:[[:space:]]+[^@[:space:]]+@[0-9a-f]{40}([[:space:]]*#.*)?$' "$file" || true)
          done < <(find .github/workflows -maxdepth 1 -type f -name '*.yml' | sort)

          if [ "$updated" -eq 0 ]; then
            echo "No workflow action SHA updates were needed."
          fi

          if git diff --quiet -- .github/workflows; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create pull request
        id: cpr
        if: steps.update.outputs.changed == 'true'
        continue-on-error: true
        uses: peter-evans/create-pull-request@22a9089034f40e5a961c8808d113e2c98fb63676 # v7
        with:
          token: ${{ secrets.FLAKE_UPDATE_TOKEN || github.token }}
          add-paths: .github/workflows/*.yml
          branch: chore/workflow-action-sha-update
          delete-branch: true
          signoff: true
          commit-message: "Update workflow action SHAs"
          title: "Update workflow action SHAs"
          body: |
            Automated update of pinned GitHub Action SHAs in workflow files.

            - Resolved each pinned action using its inline tag comment (for example `# v4`).
            - Updated `.github/workflows/*.yml` where upstream tag targets changed.

      - name: PR creation fallback info
        if: steps.update.outputs.changed == 'true' && steps.cpr.outcome == 'failure'
        run: |
          echo "::warning::Automatic PR creation failed."
          echo "::warning::Set repository secret FLAKE_UPDATE_TOKEN (PAT or GitHub App token with repo scope)."
          echo "::warning::If using GITHUB_TOKEN fallback, enable 'Allow GitHub Actions to create and approve pull requests' under Settings > Actions > General."
