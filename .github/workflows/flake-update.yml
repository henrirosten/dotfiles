name: flake update

on:
  schedule:
    # 04:00 UTC ~= 06:00 EET (07:00 in EEST / summer time)
    - cron: "0 4 * * *"
  workflow_dispatch:
  pull_request:
    paths:
      - "flake.nix"
      - "flake.lock"
      - ".github/workflows/flake-update.yml"

permissions:
  contents: write
  pull-requests: write

jobs:
  update-and-pr:
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install nix
        uses: cachix/install-nix-action@v30
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            system-features = nixos-test benchmark big-parallel kvm

      - name: Update all flake inputs
        run: nix flake update

      - name: Detect lockfile changes
        id: changes
        run: |
          if git diff --quiet -- flake.lock; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Run x1 VM codex smoke check
        if: steps.changes.outputs.changed == 'true'
        run: nix build .#checks.x86_64-linux.x1-vm-codex-smoke -L

      - name: Create pull request
        id: cpr
        if: steps.changes.outputs.changed == 'true'
        continue-on-error: true
        uses: peter-evans/create-pull-request@v7
        with:
          add-paths: flake.lock
          branch: chore/automated-flake-update
          delete-branch: true
          signoff: true
          commit-message: "Flake update"
          title: "Flake update"
          body: |
            Automated flake input update.

            - Updated all flake inputs with `nix flake update`.
            - Verified `nix build .#checks.x86_64-linux.x1-vm-codex-smoke -L`.

      - name: PR creation fallback info
        if: steps.changes.outputs.changed == 'true' && steps.cpr.outcome == 'failure'
        run: |
          echo "::warning::Automatic PR creation is disabled for GITHUB_TOKEN in repository settings."
          echo "::warning::Enable 'Allow GitHub Actions to create and approve pull requests' under Settings > Actions > General."
          echo "::warning::Manual PR URL: https://github.com/${{ github.repository }}/compare/${{ github.event.repository.default_branch }}...chore/automated-flake-update?expand=1"

  x1-vm-codex-smoke:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install nix
        uses: cachix/install-nix-action@v30
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            system-features = nixos-test benchmark big-parallel kvm

      - name: Run x1 VM codex smoke check
        run: nix build .#checks.x86_64-linux.x1-vm-codex-smoke -L
